name: Release

on:
  push:
    tags: ['v*']

permissions:
  contents: write

env:
  KDOWN_VERSION: ${{ github.ref_name }}

defaults:
  run:
    shell: bash

jobs:
  build-cli:
    name: CLI (${{ matrix.name }})
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - name: macOS-arm64
            runner: macos-14
            os: macos
            arch: aarch64
            ext: tar.gz
          - name: Linux-x64
            runner: ubuntu-latest
            os: linux
            arch: x64
            ext: tar.gz
          - name: Linux-arm64
            runner: ubuntu-24.04-arm
            os: linux
            arch: aarch64
            ext: tar.gz
          - name: Windows-x64
            runner: windows-latest
            os: windows
            arch: x64
            ext: zip
    steps:
      - uses: actions/checkout@v6

      - uses: graalvm/setup-graalvm@v1
        with:
          java-version: '21'
          distribution: 'graalvm'

      - uses: gradle/actions/setup-gradle@v5

      - name: Build native image
        run: ./gradlew :cli:nativeCompile -PVERSION_NAME=${KDOWN_VERSION#v}

      - name: Package (Unix)
        if: matrix.os != 'windows'
        run: |
          cd cli/build/native/nativeCompile
          tar -czf kdown-${{ matrix.os }}-${{ matrix.arch }}.tar.gz kdown

      - name: Package (Windows)
        if: matrix.os == 'windows'
        run: |
          cd cli/build/native/nativeCompile
          7z a kdown-${{ matrix.os }}-${{ matrix.arch }}.zip kdown.exe

      - uses: actions/upload-artifact@v6
        with:
          name: kdown-${{ matrix.os }}-${{ matrix.arch }}
          path: cli/build/native/nativeCompile/kdown-${{ matrix.os }}-${{ matrix.arch }}.${{ matrix.ext }}

  build-android:
    name: Android APK
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: 17

      - uses: gradle/actions/setup-gradle@v5

      - name: Decode keystore
        if: env.ANDROID_KEYSTORE_BASE64 != ''
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > /tmp/release.keystore

      - name: Build release APK
        env:
          ANDROID_KEYSTORE_FILE: /tmp/release.keystore
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: ./gradlew :app:android:assembleRelease -PVERSION_NAME=${KDOWN_VERSION#v}

      - name: Rename APK
        run: |
          APK=$(find app/android/build/outputs/apk/release -name '*.apk' | head -1)
          cp "$APK" app/android/build/outputs/apk/release/kdown-android.apk

      - uses: actions/upload-artifact@v6
        with:
          name: kdown-android
          path: app/android/build/outputs/apk/release/kdown-android.apk

  build-desktop:
    name: Desktop (${{ matrix.name }})
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - name: macOS
            runner: macos-latest
            task: packageReleaseDmg
            artifact: "*.dmg"
          - name: Linux-x64
            runner: ubuntu-latest
            task: packageReleaseDeb
            artifact: "*.deb"
          - name: Linux-arm64
            runner: ubuntu-24.04-arm
            task: packageReleaseDeb
            artifact: "*.deb"
          - name: Windows-x64
            runner: windows-latest
            task: packageReleaseMsi
            artifact: "*.msi"
          - name: Windows-arm64
            runner: windows-11-arm
            task: packageReleaseMsi
            artifact: "*.msi"
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: 21

      - uses: gradle/actions/setup-gradle@v5

      - name: Build desktop package
        run: ./gradlew :app:desktop:${{ matrix.task }} -PVERSION_NAME=${KDOWN_VERSION#v}

      - uses: actions/upload-artifact@v6
        with:
          name: kdown-desktop-${{ matrix.name }}
          path: app/desktop/build/compose/binaries/main-release/**/${{ matrix.artifact }}

  build-web:
    name: Web (WasmJs)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: 17

      - uses: gradle/actions/setup-gradle@v5

      - name: Build web distribution
        run: ./gradlew :app:web:wasmJsBrowserDistribution -PVERSION_NAME=${KDOWN_VERSION#v}

      - name: Package web distribution
        run: |
          cd app/web/build/dist/wasmJs/productionExecutable
          zip -r /tmp/kdown-web.zip .

      - uses: actions/upload-artifact@v6
        with:
          name: kdown-web
          path: /tmp/kdown-web.zip

  publish-maven-central:
    name: Publish to Maven Central
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: 21

      - uses: gradle/actions/setup-gradle@v5

      - name: Publish to Maven Central
        run: >
          ./gradlew publishAndReleaseToMavenCentral
          -PVERSION_NAME=${KDOWN_VERSION#v}
          --no-configuration-cache
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyId: ${{ secrets.SIGNING_KEY_ID }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.SIGNING_KEY }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.SIGNING_KEY_PASSWORD }}

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-cli, build-android, build-desktop, build-web, publish-maven-central]
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts
          merge-multiple: true

      - name: List artifacts
        run: find artifacts -type f | sort

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: artifacts/*
